---
title: 实验日志
date: 2018-08-16 15:04:50
tags: [record]
categories: 实验记录
---

## 假阳性减少

### 独立的假阳性减少
1.最初使用单个三分支卷积网络，不做等方性，三个输入大小为(26， 40， 40)、(10， 30， 30)、(6， 20， 20)，进行了十折交叉验证，FROC评分为80.5

2.(networks.py)尝试使用多模型(res、ince_res、densenet)，并使用等方性，输入大小变为(40， 40， 40)、(32， 32， 32)、(24， 24， 24)，结果求平均的方式进行LUNA16数据集上的训练，单折结果最好的是四个模型(加上之前的不做等方性的VGG模型)求平均，FROC评分为85.2
其中res模型单折FROC评分为76.4
其中den模型单折FROC评分为77.5
其中ince_res模型单折FROC评分为78.1

3.(networks_v2.py)在networks.py的基础上，将原来的不做等方性的三分支VGG网络改为做等方性，并且统一修改其卷积核大小为(3, 3, 3)，修改在network.py的基础上修改res、ince_res、den三个网络的结构，将所有模型最开始的一个(5，5，5)的大卷积核改为两个(3，3，3)的小卷积核，之后使用中心池化代替最大池化下采样，这个版本的网络只有res模型在LUNA16完整数据上进行了训练。
其中res模型单折FROC评分为80.6

4.(networks_v3.py) 在networks_v2.py的基础上，在res、ince_res、den三个网络中的块结构中的卷积块结构中添加调整通道数的(1, 1, 1)大小的卷积(其中den网络没有添加)，并使用PReLU来代替ReLU，在res模型中，还将卷积下采样改为了中心池化
其中vgg模型单折FROC评分为82.6
其中res模型单折FROC评分为 78.9
其中den模型单折FROC评分为85.3.
其中ince_res模型单折FROC评分为78.3
den模型和vgg模型的融合结果FROC评分为85.9
在densenet和vgg模型的结果上，融合hard mining训练的ince_res模型的结果进来，最终FROC可以达到87.8

5.(单分支VGG)尝试使用32大小单分支等方性的Vgg(network_v3.py)模型，训练一折，其中一次池化的Vgg，FROC评分为82.8，稍高于多分支vgg
其中两次池化的Vgg, FROC评分为80.25

### 基于结节检测的假阳性减少
1.使用单独的三分支VGG网络，不做等方性变换，输入大小为(26， 40， 40)、(10， 30， 30)、(6， 20， 20)，在结节检测的结果上进行训练，FROC评分只有60左右

2.使用三分支VGG网路，数据输入经过等方性处理，输入大小变为(40， 40， 40)、(32， 32， 32)、(24， 24， 24)，同时将卷积核大小修改为(3， 3， 3)，在结节检测的结果上进行训练，FROC评分80.4

3.(networks_v2.py)尝试修改ince_res、densenet、res三个模型中的前两个卷积层，将单个大核卷积换成多个3 * 3 * 3的小核卷积，并使用中心池化代替最大池化下采样，在结节检测的结果上划分训练集和测试集。
最终最好结果的是三个模型求平均，FROC评分87.2
其中vgg模型单折FROC评分为80.4
其中res模型单折FROC评分为81.2
其中den模型单折FROC评分为82.15
其中ince_res模型单折FROC评分为83.8

4.(networks_v3.py)尝试按照原论文简化ince_res、densenet、res三个模型的结构，并使用PReLU代替原来的ReLU激活函数，并在一些块中添加1 * 1 * 1的降维卷积(其中den网络没有添加)，增加深度同时减少计算量，在res模型中，还将卷积下采样改为了中心池化，尚未开始训练。

5.使用最新结节检测结果(tpr：93， fps： 9)进行假阳性模型的训练，正负样本均扩充108倍，总训练样本约12万。
其中densenet第一折结果FROC评分最高85.2，使用旋转增强测试集后取平均84.5
其中ince_res第一折结果FROC评分最高84.2，使用旋转增强测试集后取平均84.3
其中res第一折结果FROC评分最高83.8，使用旋转增强测试集后取平均84.9
Den和ince_res的最后一折融合后最高为86.0， 使用旋转增强测试集后取平均86.0

6.使用结节检测结果(tpr:97， fps:44)进行假阳性减少模型训练，正样本扩充108倍，负样本过采样，总训练样本30000左右
其中den第一折结果FROC评分最高75.9
其中ince_res第一折结果FROC评分最高65.2
尝试使用单分支Den模型，第一折结果FROC评分76.4

7.使用结节检测结果(tpr:97， fps:44)进行假阳性减少模型训练，正样本扩充108倍，负样本扩充4倍，然后正样本过采样，总训练样本30000左右

8.查看第五种尝试中的dense的结果，将测试集预测的结果可视化，查看预测概率比较低的正样本，其中大部分大小较小，者颜色比较暗，或者与血管粘连，而在预测概率比较高的负样本中，大部分图片中心是颜色较亮的小点或者与血管粘连的暗块，尚无解决办法.

9.使用结节检测结果(tpr：93， fps： 9)，尝试截取24大小的数据块，然后缩放到40大小，正负样本都使用旋转扩充四倍，使用三分支densenet模型，训练十代，FROC:70.9

10.使用结节检测结果(tpr：93， fps： 9)，正负样本均扩充108倍，使用单分支densenet模型模型，但是深度比之前的多分支densenet模型更深，卷积核个数比之前的多分支densenet模型更多。

11.使用结节检测结果(tpr：93， fps： 9)，加上训练集中的正样本，以平衡数据，正负样本均扩充108倍，使用network_v3中的densenet模型进行训练。学习速率衰减加快，之前是0.95/epoch，现在是0.9/epoch。
densenet最好结果为FROC:85.8，相比于之前的85.2要高一些

12.在11的基础上，使用focal loss代替二值交叉熵进行训练
densenet最好结果为FROC:85.2

13.在11的基础上，修改三分支的densenet,将其中的40大小的分支去掉，使用24和32大小的双分支网络进行训练。densenet模型的最好效果为：81.1

14.在11的基础上，修改三分支的densenet,将其中的24大小的分支去掉，使用40和32大小的双分支网络进行训练。densenet模型的最好效果为：84.7

15.在11的基础上，修改三分支的densenet,将其中的32大小的分支去掉，使用24和40大小的双分支网络进行训练。densenet模型的最好效果为：84.3

15.在11的基础上，修改三分支的densenet,将Dropout层去掉，densenet模型的最好效果为：82.9

16.将三分支的Densenet模型分成三个模型，大小分别为10 * 10 * 10，20 * 20 * 20，40 * 40 * 40, 将结节按照直径分成0~5、5~10、10~30三类，分别作为三种模型的正样本，首先训练20的模型，然后10和40的模型以20的模型为基础，进行微调，最终预测时，结节概率取三者最大值。这里有个问题在于三个模型因输入大小不同，因此PReLU层和最后的全连接层参数不能兼容，只能舍弃，后面可以尝试用ReLU代替PReLU。

### 使用HardMining的假阳性减少
1.networks_v2.py中的ince_res网络，首先随机采样40000正样本，随机选出150000负样本，然后正样本旋转扩充为四倍作为初始训练数据，每次迭代后，学习速率回到最初学习速率继续训练
初始训练结果FROC：76.7
第一次迭代后训练结果FROC：74.3

2.networks_v3.py中的网络，首先根据annotation.csv随机采样40000正样本，并从candidate_v2.csv中随机选出150000负样本作为初始训练样本，训练时正样本旋转扩充为四倍，每次迭代，在训练集中加入正负比例为1:4的错误样本(不够则补)，每次迭代后，学习速率接着上次训练最终的速率继续衰减
ince_res初始训练结果FROC：78.3
ince_res第一次迭代后训练结果FROC：81.2
den初始训练结果FROC：79.3
den第一次迭代后训练结果FROC：79.2
res初始训练结果FROC：74.1
res第一次迭代后训练结果FROC：77.3

3.使用新的hard mining策略，先划分四份负样本数据，训练四个模型，再用这四个模型选出用于hard mining第一代的数据
使用ince_res模型进行测试
其中第一次迭代FROC：62.1
第二次迭代FROC：53
第三次迭代FROC：74.2

4.首先使用所有的数据，训练出一个模型，然后使用这个模型预测训练集，挑选出数量相等的正负样本进行迭代训练。迭代的初始速率降为0.000028(0.001 * 0.7 ^ 10)