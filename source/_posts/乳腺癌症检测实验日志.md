---
title: 乳腺癌症检测实验日志
date: 2019-03-12 09:32:58
tags: [record]
categories: 实验记录
---

# 模型修改方案

## 针对anchor的修改
- 由于retinanet中原本将与gt的iou大于0.5的作为positive anchor，0.4~0.5之间的anchor直接忽视，小于0.4的作为negative anchor，这样得到的positive anchor还是太少，有些小目标被漏过，因此尝试将0.3的作为positive anchor， 0.2~0.3之间的anchor直接忽视，小于0.2的作为negative anchor,实验结果froc较低。
- 按照S3FD: Single Shot Scale-invariant Face Detector文中的统计，不同尺度的目标匹配到的anchor个数差异较大，如下图，文中提出的解决办法：因为原始是jaccard overlap 0.5为阈值来筛选anchor，这里首先将阈值下调到0.35，修改之后如果某些小目标匹配到的anchor还是太少，则首先统计出与小目标jaccard  overlap大于0.1阈值的anchor，然后按照jaccard overlap将anchor排序，选出N个jaccard overlap最大的anchor，文中将N设置为统计出的目标平均匹配的anchor个数，得到下图中的红色曲线。
{%asset_img anchor匹配统计.png anchor匹配统计%}

## 针对nms操作的修改
将常规的nms操作改成soft nms.

## anchor-free分支，代码分支：master
根据Feature Selective Anchor-Free Module for Single-Shot Object Detection论文，对retinanet进行anchor-free分支的修改。

以下是在离线随机掩码+随机扭曲的增强数据上进行的实验
|loss gamma|loss alpha|loss lambda|epsilon_e|epsilon_i|anchor比例|normal样本|initial lr|fold num|fold|froc|
|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|
|2.0|0.5|0.5|0.2|0.5|1|No|1e-5|2|0|82.37|
|2.0|0.5|0.5|0.2|0.5|1|No|1e-5|2|1|90.71|
|2.0|0.5|1.0|0.2|0.5|1|No|1e-5|2|0|86.78|
|2.0|0.5|1.0|0.2|0.5|1|No|1e-5|2|1|91.43|
|2.0|0.5|0.5|0.2|0.5|0.5、1、2|No|1e-5|2|0|83.39|
|2.0|0.5|1.0|0.2|0.5|0.5、1、2|No|1e-5|2|0|83.39|
|2.0|0.5|1.0|0.4|0.5|1|No|1e-5|2|0|83.78|
|2.0|0.5|1.0|0.6|0.8|1|No|1e-5|2|0|81.36|
|2.0|0.5|1.0|0.8|1.0|1|No|1e-5|2|0|83.39|
|2.0|0.5|1.0|1.0|1.0|1|No|1e-5|2|0|86.78|
|2.0|0.5|1.0|1.0|1.0|1|No|1e-5|2|1|88.93|
|2.0|0.5|1.5|1.0|1.0|1|No|1e-5|2|0|82.71|

以下是将C5替换成P5之后，在离线随机掩码+随机扭曲的增强数据上进行的实验
|loss gamma|loss alpha|loss lambda|epsilon_e|epsilon_i|anchor比例|normal样本|initial lr|fold num|fold|froc|
|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|
|2.0|0.5|1.0|1.0|1.0|1|No|1e-5|2|0||
|2.0|0.5|1.0|1.0|1.0|1|No|1e-5|2|1||

使用小样本复制+小样本图片过采样训练得到的结果
|loss gamma|loss alpha|loss lambda|epsilon_e|epsilon_i|anchor比例|normal样本|initial lr|fold num|fold|froc|
|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|
|2.0|0.5|1.0|0.2|0.5|1|No|1e-5|2|0|85.42|

## 在分类子网络中加入center-ness分支，代码分支：center_ness
center-ness分支的初始化，和anchor-based的分类层相同：
|epsilon_e|epsilon_i|loss lambda|loss for center-ness|replace C5 with P5|froc|
|:------:|:------:|:------:|:------:|:------:|:------:|
|1.0|1.0|1.0|binary crossentropy|No|82.03|
|1.0|1.0|1.0|huber without negative|No|85.76|
|1.0|1.0|1.0|binary crossentropy|Yes|85.76|
|1.0|1.0|1.0|binary crossentropy without negative|Yes||
|1.0|1.0|1.0|huber without negative|Yes|82.71|
|1.0|1.0|1.0|huber with negative|Yes|center-ness目标类别极度不平衡，训练后center-ness输出全0，导致anchor-free分支无输出|

center-ness分支的初始化使用keras默认参数：
|epsilon_e|epsilon_i|loss lambda|loss for center-ness|replace C5 with P5|froc|
|:------:|:------:|:------:|:------:|:------:|:------:|
|1.0|1.0|1.0|huber without negative|Yes|83.39|

使用huber without negative作为center-ness分支的损失函数，同时使用P5替换C5来产生P6，训练损失函数的比例大概如下：

anchor_regression : anchor_classification : anchor-free : center-ness = 2.5 : 2 : 2: 0.02

因此尝试在各个损失值以及学习速率上乘上一个常数因子，达到平衡损失值，同时又不改变更新步长的效果。
实验如下：
|anchor_regression|anchor_classification|anchor-free|center-ness|lr|froc|
|:------:|:------:|:------:|:------:|:------:|:------:|
|0.4|0.5|1|50|1.5|82.37|
|0.4|0.5|1|10|2||

使用binary crossentropy作为center-ness分支的损失函数，同时使用P5替换C5来产生P6，调整损失函数比例如下：
|anchor_regression|anchor_classification|anchor-free|center-ness|lr|froc|
|:------:|:------:|:------:|:------:|:------:|:------:|
|1|1|1|50|1|84.07|

## 在回归子网络中加入center-ness分支，代码分支：center_ness_from_reg_branch
|epsilon_e|epsilon_i|loss lambda|loss for center-ness|replace C5 with P5|fold|froc|
|:------:|:------:|:------:|:------:|:------:|:------:|:------:|
|1.0|1.0|1.0|huber without negative|No|0|85.76|
|1.0|1.0|1.0|binary crossentropy|Yes|0|88.14|
|1.0|1.0|1.0|binary crossentropy|Yes|1|88.21|

## FCOS论文+anchor-based分支，代码分支：fcos_with_anchor
|loss for center-ness|replace C5 with P5|fold|froc|
|:------:|:------:|:------:|:------:|
|binary crossentropy|Yes|0|82.03|

## 尝试完全使用FCOS论文中的想法，不要anchor-free分支，代码分支：fcos
|loss for center-ness|replace C5 with P5|fold|froc|
|:------:|:------:|:------:|:------:|
|binary crossentropy|Yes|0||

## 尝试classification和regression两个分支都进行center-ness预测，最终取平均，代码分支：center_ness_average
|loss for center-ness|replace C5 with P5|fold|froc|
|:------:|:------:|:------:|:------:|
|binary crossentropy|Yes|0||

## 尝试center-ness和classification相乘之后再计算classification loss(训练目标也是相乘之后的)，代码分支：center_ness_train_with_classification
|loss for center-ness|loss for anchor-free classification|replace C5 with P5|fold|froc|
|:------:|:------:|:------:|:------:|:------:|
|binary crossentropy|focal|Yes|0||

# 数据增强
## 在线数据增强
|loss gamma|loss alpha|train steps|数据resize|normal样本|randmask|elastic|cutout|initial lr|fold num|fold|froc|recall_vallfpr|
|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|
|0.5|2.0|anno*1|No|No|0|0|0|1e-5|2|0|83.93||
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0|0|1e-5|2|0|84.64||
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5|0|1e-5|2|0|80.71||
|0.5|2.0|anno*1|(1/2, 1/2)|No|0.1|0|0|1e-5|2|0|85.00||
|0.5|2.0|anno*1|No|No|0.5|0|0|1e-5|2|0|71.79||
|0.5|2.0|anno*1|(1/2, 1/2)|No|0.5|0|0|1e-5|2|0|30.36||
|0.5|2.0|anno*1|(1/2, 1/2)|No|0.5|0.5|0|1e-5|2|0|32.86||
|0.5|2.0|anno*5|(1/2, 1/2)|No|0.3 no drop|0.8|0|1e-5|2|0|91.07 e9|-0.4917 e7|
|0.5|2.0|anno*5|(1/2, 1/2)|No|0.5 no drop|0.8|0|1e-5|2|1|80.34 e25|-0.4623 e14|
|0.5|2.0|anno*5|(1/2, 1/2)|No|0.5 no drop|0.8|0|1e-5|2|0|91.43 e8|-0.4917 e4|
|0.5|2.0|anno*5|(1/2, 1/2)|No|0.5 no drop|0.5|0|1e-5|2|0|92.86||
|0.5|2.0|anno*5|(1/2, 1/2)|No|0.5 no drop|0.5|0|1e-5|2|1|79.32||
|0.5|2.0|anno*10|(1/2, 1/2)|No|0.5 no drop|0.5|0|1e-5|2|0|92.86 e5|-0.4917 e3|
|0.5|2.0|anno*10|(1/2, 1/2)|No|0.5 no drop|0.5|0|1e-5|2|1|75.93 e16|1.725 e8|
|0.5|2.0|anno*1|(1/2, 1/2)|Yes|0.5|0|0|1e-5|2|0|80.00||
|0.5|2.0|anno*1|(1/2, 1/2)|Yes|0|0.5|0|1e-5|2|0|62.14||
|0.5|2.0|anno*1|No|No|0.5|0|0|1e-3|2|0|11.79||
|0.5|2.0|anno*1|No|Yes|0.5|0|0|1e-5|2|0|87.50||
|0.5|2.0|anno*1|No|Yes|0.5|0|0|1e-5|2|1|70.51||
|0.5|2.0|anno*5|No|Yes|0.5|0|0|1e-5|2|0|89.64||
|0.5|2.0|anno*5|(1/2, 1/2)|Yes|0.5 no drop|0|0|1e-5|2|0|91.07 e16| -0.5031 e18|
|0.5|2.0|anno*5|(1/2, 1/2)|No|0.5 no drop|0|0|1e-5|2|0|92.86|-0.4921|
|0.5|2.0|anno*1|No|No|0|0.5|0|1e-5|2|0|82.50||
|0.5|2.0|anno*1|No|No|0.5|0.5|0.5|1e-5|2|0|32.86||
|0.5|2.0|anno*10|No|No|0.5|0.5|0.5|1e-5|2|0|87.14||
|0.5|2.0|anno*10|No|No|0.5 no drop|0.5|0.5|1e-5|2|0|92.14 e12|-0.4912 e20|
|0.5|2.0|anno*10|No|No|0.5 no drop|0.5|0.5|1e-5|2|1|80.34 e17|-0.4672 e5|
|0.5|2.0|anno*1|No|Yes|0.5|0.5|0|1e-5|2|0|78.93||
|0.5|2.0|anno*1|No|Yes|0|0|0|1e-5|2|0|78.21||
|0.5|2.0|anno*1|No|No|0.1|0.1|0|1e-5|2|0|80.71||
|0.5|2.0|anno*1|No|No|0.5|0|0|1e-5|2|0|80.71||

## 离线数据增强
|loss gamma|loss alpha|train steps|数据resize|normal样本|random contrast|randmask|elastic|cutout|initial lr|fold num|fold|froc|recall_vallfpr|
|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|:------:|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop| ori * 4 |3/15(b、m、bm)|1e-5|2|1|81.36 e21|-0.4665 e10|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop| ori * 4 |0|1e-5|2|0|92.86 e39|-0.5139 e39|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop| ori * 4 |0|1e-5|2|1|81.69 e8|-0.4658 e8|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop| forward transform ori * 4 |0|1e-5|2|0|93.57 e8|-0.4917 e11|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop| forward transform ori * 4 |0|1e-5|2|1|80.34 e20|-0.4754 e9|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop| ori * 4 |0|1e-5|2|0 exclude one|93.09 e24|-0.5013 e19|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop| ori * 4 |0|1e-5|2|1 exclude one|82.41 e23|-0.4711 e4|
|0.5|2.0|anno*1|no resize (1200, 1600)|No|0|0.5 no drop| ori * 4 |0|1e-5|2|1|||
|0.5|2.0|anno*1|(1/2, 1/2)|Yes|0|0.5 no drop without no anno| ori * 4 |0|1e-5|2|1|83.73 e12|-0.4711 e12|
|0.5|2.0|anno*1|(1/2, 1/2)|Yes|0|0.5 no drop without no anno| ori * 4 |0|1e-5|2|0|90.71 e26|-0.5022 e31|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0.5|0.5 no drop| ori * 4 |0|1e-5|2|1|78.64 e2|-0.4684 e2|
|0.5|2.0|anno*1|(1/2, 1/2)|Yes|0|0.5 no drop| ori * 4 |0|1e-5|2|0|89.29 e9|-0.4872 e9|
|0.5|2.0|anno*1|(1/2, 1/2)|Yes|0|0.5 no drop| ori * 4 |0|1e-5|2|1|80.34 e22|1.651 e13|
|0.5|2.0|anno*1|(1/2, 1/2)|Yes|0|0.5 no drop|0|0|1e-5|2|0|||
|0.5|2.0|anno*1|(1/2, 1/2)|Yes|0|0.5 no drop|0|0|1e-5|2|1|79.66 e10|1.698 e10|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop|0|0|1e-5|5|0|88.18 e20|-0.4893 e14|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop|0|0|1e-5|5|1|86.08 e19|-0.4749 e15|
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop|0|0|1e-5|5|2|||
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop|0|0|1e-5|5|3|||
|0.5|2.0|anno*1|(1/2, 1/2)|No|0|0.5 no drop|0|0|1e-5|5|4|||